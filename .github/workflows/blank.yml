name: ðŸª Close TTRPG Hook

on:
  workflow_dispatch:
    inputs:
      hook_template:
        description: 'Select the Hook Template to complete (from Open_Hooks/)'
        required: true
        type: choice
        # NOTE: This list must be manually updated whenever a new file is added to Open_Hooks/
        options:
          - 'OH-02-The-Mechanus-Manor.md'
      completed_hook_content:
        description: |
          Paste the **completed** content for your Hook here.
          (Copy the selected template, edit it offline, and paste the final result here.)
        required: true
        type: textarea
      title:
        description: 'Title for the new Pull Request (e.g., Completed Hook: The Mechanus Manor)'
        required: true
        type: string

jobs:
  submit_hook:
    name: Process and Submit Hook
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed for git operations
      pull-requests: write # Needed to create the PR
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: ðŸ“ Determine New Hook Filename
        id: filename
        run: |
          TEMPLATE_NAME="${{ github.event.inputs.hook_template }}"
          NEW_FILENAME="$(basename -s .md ${TEMPLATE_NAME} )-Completed.md"
          echo 'TEMPLATE_NAME="${TEMPLATE_NAME}"' >> $GITHUB_ENV
          echo 'NEW_FILENAME="${NEW_FILENAME}"' >> $GITHUB_ENV

          # to stdout
          echo "NEW_FILENAME=${NEW_FILENAME}" >> $GITHUB_OUTPUT
          
      - name: ðŸ’¾ Create Completed Hook File
        run: |
          echo "${{ github.event.inputs.completed_hook_content }}" > Open_Hooks/${TEMPLATE_NAME}
          mv Open_Hooks/${TEMPLATE_NAME} Closed_Hooks/${{ steps.filename.outputs.NEW_FILENAME }}
        shell: bash
        
      - name: ðŸŒ³ Create New Branch, Commit, and Push
        run: |
          BRANCH_NAME="feature/hook-submission-${{ github.run_id }}"
          
          git checkout -b $BRANCH_NAME
          
          git add Closed_Hooks/${{ steps.filename.outputs.NEW_FILENAME }}
          git commit -m "feat: Completed hook: ${{ github.event.inputs.hook_template }}"
          git push origin $BRANCH_NAME
        shell: bash

      - name: ðŸš€ Create Pull Request
        env:
          # ðŸŸ¢ CORRECTED SECRET REFERENCE HERE
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_TITLE: ${{ github.event.inputs.title }}
          PR_BODY: |
            ## New Hook Submission
            
            This Pull Request contains the completed TTRPG Hook based on the **${{ github.event.inputs.hook_template }}** template.
            
            * **Template Used:** `${{ github.event.inputs.hook_template }}`
            * **Submitted by:** @${{ github.event.sender.login }}
            * **Destination File:** `Closed_Hooks/${{ steps.filename.outputs.NEW_FILENAME }}`
            
            Please review the content for canon compliance and structure before merging.
        run: |
          gh pr create \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --base main \
            --head feature/hook-submission-${{ github.run_id }}
