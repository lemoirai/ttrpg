name: ü™ù Submit TTRPG Hook

on:
  workflow_dispatch:
    inputs:
      hook_template:
        description: 'Select the Hook Template to complete (from Open_Hooks/)'
        required: true
        type: choice
        # NOTE: This list must be manually updated whenever a new file is added to Open_Hooks/
        options:
          - 'OH-02-The-Mechanus-Manor.md'
      completed_hook_content:
        description: |
          Paste the **completed** content for your Hook here.
          (Copy the selected template, edit it offline, and paste the final result here.)
        required: true
        type: textarea
      title:
        description: 'Title for the new Pull Request (e.g., Completed Hook: The Mechanus Manor)'
        required: true
        type: string

jobs:
  submit_hook:
    name: Process and Submit Hook
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed for git operations
      pull-requests: write # Needed to create the PR
    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: üìù Determine New Hook Filename
        id: filename
        run: |
          TEMPLATE_NAME="${{ github.event.inputs.hook_template }}"
          NEW_FILENAME="${TEMPLATE_NAME/OH-02/OH-02-Completed_}"
          echo "NEW_FILENAME=${NEW_FILENAME}" >> $GITHUB_OUTPUT
          
      - name: üíæ Create Completed Hook File
        run: |
          echo "${{ github.event.inputs.completed_hook_content }}" > ${{ steps.filename.outputs.NEW_FILENAME }}
        shell: bash

      - name: ‚öôÔ∏è Setup GitHub CLI
        # üü¢ CORRECTED ACTION NAME HERE
        uses: cli/cli/setup-gh@v2
        
      - name: üå≥ Create New Branch, Commit, and Push
        run: |
          BRANCH_NAME="feature/hook-submission-${{ github.run_id }}"
          
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          git checkout -b $BRANCH_NAME
          
          mv ${{ steps.filename.outputs.NEW_FILENAME }} Closed_Hooks/
          
          git add Closed_Hooks/${{ steps.filename.outputs.NEW_FILENAME }}
          git commit -m "feat: Completed hook: ${{ github.event.inputs.hook_template }}"
          git push origin $BRANCH_NAME
        shell: bash

      - name: üöÄ Create Pull Request
        env:
          # üü¢ CORRECTED SECRET REFERENCE HERE
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_TITLE: ${{ github.event.inputs.title }}
          PR_BODY: |
            ## New Hook Submission
            
            This Pull Request contains the completed TTRPG Hook based on the **${{ github.event.inputs.hook_template }}** template.
            
            * **Template Used:** `${{ github.event.inputs.hook_template }}`
            * **Submitted by:** @${{ github.event.sender.login }}
            * **Destination File:** `Closed_Hooks/${{ steps.filename.outputs.NEW_FILENAME }}`
            
            Please review the content for canon compliance and structure before merging.
        run: |
          gh pr create \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --base main \
            --head feature/hook-submission-${{ github.run_id }}
